//*****************************************************************************************
// Copyright (c) 2000 Michael Kurz
// All rights reserved.
// If you want to use this source in your applications conatct: <MichaelKurz@gmx.at>
//
// $FileName    : mUserAndComputerName.pkg
// $ProjectName : General shared classes
// $Author      : Michael Kurz <MichaelKurz@gmx.at>
// $Created     : 12-31-2000 @ 09:00
//
// Contents:
//
// $Rev History
//
//*****************************************************************************************
Use mPointer.pkg

#IFNDEF gsComputerName
Global_Variable String gsComputerName
#ENDIF
#IFNDEF gsUserName
Global_Variable String gsUserName
#ENDIF

External_Function xxGetComputerName "GetComputerNameA" kernel32.dll Pointer lpszName Pointer lpdwcBuffer Returns Integer
External_Function WNetGetUser1 "WNetGetUserA" MPR.DLL Pointer lpName Pointer lpUserName Pointer lpLength Returns DWord
Function xxComputerName Desktop Returns String
    String  sName sLength sComputerName
    Pointer lpName_Addr lpLength_Addr
    Integer iRetval
    Movestr (Repeat (Character (0), 25))                    to sName
    GetAddress of sName                                     to lpName_Addr
    Movestr (DwordToBytes (25))                             to sLength
    GetAddress of sLength                                   to lpLength_Addr
    Moveint (xxGetComputerName(lpName_Addr, lpLength_Addr)) to iRetval
    Move (cstring(sName))                                   to sName
    If (sName = "") Begin
        Move "DEFAULT"                                      to sName
    End
    Move (CString(sname))                                   to sComputerName
    Function_Return sComputerName
End_Function

Function NetzwerkBenutzer Global Returns String
    String sName sLength
    Pointer lpName_Addr lpLength_Addr
    Integer iRetval

    Movestr (Repeat (Character (0), 255))                   to sName
    GetAddress of sName                                     to lpName_Addr
    Movestr (DwordToBytes (255))                            to sLength
    GetAddress of sLength                                   to lpLength_Addr
    Moveint (WNetGetUser1 (0, lpName_Addr, lpLength_Addr))   to iRetval
    If iRetval Eq 0 Begin
        Move (Cstring(sname))                   to sName
    End
    Else Begin
        Move "DEFAULT"                                     to sName
    End
    If sName Eq "" Begin
        Move "DEFAULT"                           to sName
    End
    Move sName  to gsUserName
    Function_Return sName
End_Function

Get NetzwerkBenutzer to gsUserName
Get xxComputerName to gsComputerName

// Only for testing purposes...

External_Function GetUserNameEx "GetUserNameExA" Secur32.DLL DWord iFormat Pointer pName Integer iSize Returns Integer
Function DFGetUserNameEx Global Integer iFormat Returns String
    Local_Buffer  sName pName 1024
    Local_Buffer  sDW   pDW
    Integer iRet
    Move (DWordToBytes(1024))                   to sDW
    GetAddress of sDW                           to pDW
    GetAddress of sName                         to pName
    Move (GetUserNameEx(iFormat,pName,pDW))     to iRet
    Function_Return (CString(sName))
End_Function

External_Function GetUserName "GetUserNameA" AdvApi32.DLL Pointer pName Integer iSize Returns Integer
Function DFGetUserName Global Returns String
    Local_Buffer  sName pName 1024
    Local_Buffer  sDW   pDW
    Integer iRet
    Move (DWordToBytes(1024))                   to sDW
    GetAddress of sDW                           to pDW
    Move (GetUserName(pName,pDW))               to iRet
    Function_Return (CString(sName))
End_Function